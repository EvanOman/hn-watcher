#!/bin/bash
# sysd - Systemd Service Manager wrapper script

set -e

# Get the project root directory
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SYSD_DIR="$PROJECT_ROOT/tools/sysd"

# Check if sysd directory exists
if [[ ! -d "$SYSD_DIR" ]]; then
    echo "Error: sysd directory not found at $SYSD_DIR" >&2
    exit 1
fi

# Change to sysd directory
cd "$SYSD_DIR"

# Check if we need to install dependencies
if [[ ! -f ".venv/bin/activate" ]] && [[ -z "$VIRTUAL_ENV" ]]; then
    echo "Installing sysd dependencies..." >&2
    if command -v uv &> /dev/null; then
        uv sync --extra dev
    else
        python3 -m venv .venv
        source .venv/bin/activate
        pip install -e ".[dev]"
    fi
fi

# Run sysd with uv if available, otherwise use activated venv
if command -v uv &> /dev/null; then
    exec uv run python -m sysd "$@"
else
    # Activate virtual environment if not already active
    if [[ -z "$VIRTUAL_ENV" ]] && [[ -f ".venv/bin/activate" ]]; then
        source .venv/bin/activate
    fi
    exec python -m sysd "$@"
fi